# üî• Firebase Setup Instructions

## ‚úÖ Completed Steps

1. ‚úÖ **Added Firebase dependencies to `pubspec.yaml`**
   - firebase_core: ^2.24.0
   - firebase_performance: ^0.9.3+8
   - firebase_crashlytics: ^3.4.8
   - firebase_analytics: ^10.7.4

2. ‚úÖ **Ran `flutter pub get`** - All dependencies installed successfully

3. ‚úÖ **Instrumented code with performance traces**
   - `lib/services/traccar_socket_service.dart` - JSON parse tracking
   - `lib/core/data/vehicle_data_repository.dart` - Position batch tracking

## üîß Required: Firebase Configuration

Before Firebase can work, you need to configure your Firebase project and generate the configuration files.

### Option 1: FlutterFire CLI (Recommended)

**Step 1: Install FlutterFire CLI**
```powershell
dart pub global activate flutterfire_cli
```

**Step 2: Login to Firebase**
```powershell
firebase login
```

**Step 3: Configure FlutterFire**
```powershell
flutterfire configure
```

This will:
- Prompt you to select or create a Firebase project
- Automatically register your Android/iOS apps
- Generate `lib/firebase_options.dart` with all configuration
- Add google-services.json (Android) and GoogleService-Info.plist (iOS)

**Step 4: Select platforms**
When prompted, select:
- ‚úÖ Android
- ‚úÖ iOS (if you have iOS deployment)
- ‚ùå Web (optional)
- ‚ùå macOS (optional)

### Option 2: Manual Configuration

If you prefer manual setup or FlutterFire CLI doesn't work:

#### Android Setup

1. **Create Firebase project** at https://console.firebase.google.com
2. **Add Android app** with package name: `com.example.my_app_gps` (check `android/app/build.gradle` for actual package)
3. **Download `google-services.json`** and place in `android/app/`
4. **Update `android/build.gradle`**:
   ```gradle
   buildscript {
     dependencies {
       // Add this line
       classpath 'com.google.gms:google-services:4.4.0'
     }
   }
   ```
5. **Update `android/app/build.gradle`**:
   ```gradle
   apply plugin: 'com.android.application'
   apply plugin: 'kotlin-android'
   apply from: "$flutterRoot/packages/flutter_tools/gradle/flutter.gradle"
   
   // Add this line
   apply plugin: 'com.google.gms.google-services'
   ```

#### iOS Setup (if applicable)

1. **Add iOS app** to Firebase project
2. **Download `GoogleService-Info.plist`** and place in `ios/Runner/`
3. **Update `ios/Podfile`** to use iOS 12.0+

### Step 5: Update main.dart

Once `firebase_options.dart` is generated, update `lib/main.dart`:

**Add imports at the top:**
```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'package:firebase_performance/firebase_performance.dart';
import 'package:my_app_gps/core/performance/frame_time_monitor.dart';
import 'firebase_options.dart'; // Generated by FlutterFire CLI
```

**Update `main()` function (add after `WidgetsFlutterBinding.ensureInitialized();`):**
```dart
Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // ========== FIREBASE INITIALIZATION ==========
  try {
    await Firebase.initializeApp(
      options: DefaultFirebaseOptions.currentPlatform,
    );
    print('[FIREBASE] ‚úÖ Firebase initialized successfully');
    
    // Enable Performance Monitoring
    await FirebasePerformance.instance.setPerformanceCollectionEnabled(true);
    print('[FIREBASE] ‚úÖ Performance monitoring enabled');
    
    // Enable Crashlytics
    FlutterError.onError = (errorDetails) {
      FirebaseCrashlytics.instance.recordFlutterFatalError(errorDetails);
    };
    PlatformDispatcher.instance.onError = (error, stack) {
      FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
      return true;
    };
    print('[FIREBASE] ‚úÖ Crashlytics enabled');
    
    // Start frame time monitoring
    FrameTimeMonitor().start();
    print('[FIREBASE] ‚úÖ Frame time monitoring started');
  } catch (e, stack) {
    print('[FIREBASE] ‚ùå Firebase initialization failed: $e');
    print('[FIREBASE] Stack trace: $stack');
    // App can still run without Firebase (traces will fail gracefully)
  }
  // ============================================

  // ... rest of existing initialization code ...
  
  if (kDebugMode || kProfileMode) {
    debugPrint(
        '[RENDER] Graphics backend: ${RendererBinding.instance.runtimeType}',);
  }
  
  // ... rest of main() ...
}
```

## üß™ Testing Firebase Integration Locally

### Step 1: Enable Debug Logging

```powershell
# Connect device/emulator
adb devices

# Enable Firebase Performance debug logging
adb shell setprop log.tag.FirebasePerformance DEBUG

# Enable Firebase Crashlytics debug logging
adb shell setprop log.tag.FirebaseCrashlytics DEBUG

# Watch logs
adb logcat | Select-String "Firebase"
```

### Step 2: Run the App

```powershell
flutter run --release
```

### Step 3: Verify Traces Appear

Look for logs like:
```
[PERF_TRACE] Started trace: ws_json_parse
[PERF_TRACE] Stopped trace: ws_json_parse (duration: 3ms)
[PERF_TRACE] Started trace: position_batch
[PERF_TRACE] Stopped trace: position_batch (duration: 15ms)
[FRAME_MONITOR] ‚úÖ Good performance: avg=12ms, p95=14ms
```

### Step 4: Check Firebase Console

1. Go to https://console.firebase.google.com
2. Select your project
3. Navigate to **Performance** ‚Üí **Custom traces**
4. You should see:
   - `ws_json_parse` trace
   - `position_batch` trace
   - Frame time metrics

**Note**: Firebase Performance data may take 1-24 hours to appear in console for first time.

## üö® Troubleshooting

### Issue: "Default FirebaseApp is not initialized"

**Solution**: Make sure you ran `flutterfire configure` and `firebase_options.dart` exists.

### Issue: "google-services.json not found"

**Solution**: 
1. Check `android/app/google-services.json` exists
2. Run `flutter clean && flutter pub get`
3. Rebuild app

### Issue: Firebase Performance not showing data

**Solution**:
1. Wait 24 hours for first data to appear
2. Ensure you're running in **release mode** (`flutter run --release`)
3. Debug mode performance data is filtered by Firebase
4. Check logcat for errors: `adb logcat | Select-String "Firebase"`

### Issue: Performance traces failing silently

**Solution**: This is expected! The code has try-catch blocks, so the app works even without Firebase configured. Check logs for specific errors.

## üìä Expected Performance Metrics

Once Firebase is configured and app is running, you should see:

### ws_json_parse trace
- **Avg duration**: 2-5ms (main thread)
- **Metrics**:
  - `payload_size_bytes`: Size of JSON payload
  - `used_isolate`: 0 (small payloads) or 1 (large payloads >1KB)
  - `device_count`: Number of devices in payload

### position_batch trace
- **Avg duration**: 10-50ms (depending on batch size)
- **Metrics**:
  - `update_count`: Number of updates received
  - `flushed_count`: Number of updates actually flushed
  - `batch_window_ms`: 200 (batching window)

### Frame Time Metrics
- `frame_time_avg_ms`: Target <16ms (60 FPS)
- `frame_time_p95_ms`: Target <20ms
- `dropped_frames_percent`: Target <5%

## ‚úÖ Success Criteria

Firebase is properly configured when:

1. ‚úÖ App builds without Firebase-related errors
2. ‚úÖ `adb logcat` shows "Firebase initialized successfully"
3. ‚úÖ Performance traces appear in logcat
4. ‚úÖ No "FirebaseApp not initialized" errors
5. ‚úÖ (Within 24h) Custom traces appear in Firebase Console

## üöÄ Next Steps After Firebase Setup

1. **Local testing** - Test with different payload sizes
2. **Staging deployment** - Deploy to Firebase App Distribution
3. **24-hour soak test** - Follow test plan in `DEPLOYMENT_GUIDE_ASYNC_OPTIMIZATION.md`
4. **Production rollout** - Gradual rollout via Remote Config

---

## üìù Quick Reference Commands

```powershell
# Install FlutterFire CLI
dart pub global activate flutterfire_cli

# Configure Firebase
flutterfire configure

# Run app in release mode
flutter run --release

# Enable Firebase debug logging
adb shell setprop log.tag.FirebasePerformance DEBUG
adb shell setprop log.tag.FirebaseCrashlytics DEBUG

# Watch Firebase logs
adb logcat | Select-String "Firebase"

# Build release APK
flutter build apk --release

# Clean and rebuild
flutter clean ; flutter pub get ; flutter run --release
```

---

**Current Status**: Firebase dependencies installed ‚úÖ, Code instrumented ‚úÖ, **Awaiting Firebase configuration** ‚è≥

**Next Action**: Run `flutterfire configure` to generate Firebase configuration files, then update `main.dart` with Firebase initialization.
