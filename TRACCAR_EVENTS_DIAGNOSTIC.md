# Traccar Events Diagnostic Guide

## Issue Summary
The app receives WebSocket messages for `positions` and `devices`, but NOT for `events`. This prevents notifications from appearing in the NotificationsPage.

## Root Cause Analysis

### Why Events Might Not Appear

#### 1. **No Events Are Being Generated** (Most Likely)
Traccar only sends events when they actually occur. Unlike positions (sent continuously while device is moving), events are triggered by specific conditions:

- **deviceOffline**: Device hasn't reported in X minutes
- **deviceOnline**: Device came back online
- **ignitionOn**: Vehicle ignition turned on
- **ignitionOff**: Vehicle ignition turned off
- **geofenceEnter**: Device entered a geofence
- **geofenceExit**: Device exited a geofence
- **alarm**: SOS/panic button pressed
- **overspeed**: Speed exceeded configured limit
- **maintenance**: Maintenance due

**If none of these conditions occur, no events will be sent.**

#### 2. **Traccar Server Configuration**
- Events might not be enabled for your device
- Event types might not be configured
- User permissions might not include event access

#### 3. **WebSocket Behavior**
- Traccar WebSocket sends events in real-time ONLY when they occur
- Historical events must be fetched via REST API `/api/events`

## Diagnostic Steps

### Step 1: Verify WebSocket Connection ✅
**Status:** WORKING (confirmed by positions/devices messages)

### Step 2: Check Traccar Server Configuration

#### A. Login to Traccar Web UI
```
URL: http://37.60.238.215:8082
Username: <your username>
Password: <your password>
```

#### B. Check Device Settings
1. Go to **Devices** → Select your device (fmb920)
2. Click **Edit** → **Attributes** tab
3. Look for:
   - `event.overspeedLimit`: Speed limit for overspeed events
   - `event.motionTimeout`: Time before motion stop event
   - `processing.copyAttributes`: Should include event-related attributes

#### C. Check Notifications (Events Configuration)
1. Go to **Settings** → **Notifications**
2. Verify event types are enabled:
   - ☑ deviceOnline
   - ☑ deviceOffline
   - ☑ geofenceEnter
   - ☑ geofenceExit
   - ☑ ignitionOn
   - ☑ ignitionOff
   - ☑ overspeed
3. Check if notifications are assigned to your user/device

#### D. Check User Permissions
1. Go to **Settings** → **Users** → Edit your user
2. Verify permissions include:
   - ☑ Read events
   - ☑ Device notifications

### Step 3: Trigger Test Events

#### Test Event 1: Device Offline/Online
```bash
# Stop the device simulator for 5+ minutes
# Traccar should generate deviceOffline event

# Restart device
# Traccar should generate deviceOnline event
```

#### Test Event 2: Ignition On/Off
**Requirement:** Device must report ignition status in attributes

Current device logs show:
```
"attributes": {
  "ignition": true,  ← Device reports ignition
  ...
}
```

**Test Steps:**
1. Turn off vehicle ignition
2. Wait 30 seconds
3. Check WebSocket logs for `{"events":[{"type":"ignitionOff"...}]}`
4. Turn on ignition
5. Check for `{"events":[{"type":"ignitionOn"...}]}`

#### Test Event 3: Geofence Enter/Exit
**Requirement:** Geofence must be configured in Traccar

**Setup:**
1. Go to Traccar UI → **Geofences**
2. Click **Add Geofence**
3. Draw a circle around current device location
4. Save as "Test Zone"
5. Link geofence to device: **Devices** → **fmb920** → **Geofences** → Select "Test Zone"

**Test:**
1. Device inside geofence → no event
2. Drive device outside geofence → `geofenceExit` event
3. Drive back inside → `geofenceEnter` event

#### Test Event 4: Overspeed
**Setup:**
1. Traccar UI → **Devices** → **fmb920** → **Edit**
2. **Attributes** tab → Add:
   ```
   Key: speedLimit
   Value: 30
   ```
3. Save

**Test:**
1. Drive vehicle over 30 km/h
2. Should trigger `overspeed` event

### Step 4: Monitor WebSocket Messages

The app already logs all WebSocket messages. Look for:

```dart
[SOCKET] 📨 RAW WebSocket message received:
[SOCKET] {"events":[...]}  ← THIS LINE
[SOCKET] 🔔 Received events from WebSocket
```

**If you see this:** Events are being sent, check repository processing

**If you DON'T see this:** Events are not being generated by Traccar

### Step 5: Fetch Historical Events via API

Even without WebSocket events, you can test event parsing:

1. Trigger event manually in Traccar (e.g., create geofence violation)
2. In app, pull to refresh notifications page
3. App will call `/api/events` REST endpoint
4. Check logs:
   ```
   [EventService] 🔍 Fetching events: ...
   [EventService] ✅ Fetched X events from API
   [NotificationsRepository] 📦 Loaded X cached events
   ```

## Expected Behavior After Fix

### When Event Occurs:
```
1. Traccar Server: Device violates condition
2. Traccar Server: Creates event in database
3. Traccar Server: Sends via WebSocket
   {"events":[{"id":123,"type":"ignitionOff","deviceId":1,...}]}
4. App: TraccarSocketService receives message
   [SOCKET] 🔔 Received events from WebSocket
5. App: CustomerWebSocketProvider wraps as CustomerEventsMessage
6. App: NotificationsRepository._handleWebSocketEvents()
   [NotificationsRepository] 📨 Received WebSocket events
   [NotificationsRepository] 📨 Parsed 1 events from WebSocket
7. App: EventsDao.upsertMany() → ObjectBox
   [NotificationsRepository] ✅ Persisted 1 WebSocket events
8. App: UI stream updates
   [NotificationsRepository] 📤 Emitted 1 events to UI stream
9. App: Toast notification appears
   [NotificationToast] 🔔 Ignition Off
10. App: NotificationsPage list updates
```

## Verification Commands

### Check if Traccar Server Has Events
```bash
# SSH to Traccar server (if you have access)
curl -X GET "http://37.60.238.215:8082/api/events?deviceId=1" \
  -H "Cookie: JSESSIONID=<your_session_id>"
```

### Enable Traccar Server Debug Logging
Edit `traccar.xml`:
```xml
<entry key='logger.level'>debug</entry>
```

Restart Traccar:
```bash
sudo systemctl restart traccar
```

Check logs:
```bash
tail -f /opt/traccar/logs/tracker-server.log
```

Look for event generation messages.

## Common Issues & Solutions

### Issue 1: "No events in database"
**Cause:** No events have been triggered yet  
**Solution:** Manually trigger event (see Test Events above)

### Issue 2: "Events in database but not via WebSocket"
**Cause:** WebSocket subscription might not include events  
**Solution:** Already fixed in our code (customerWebSocketProvider)

### Issue 3: "Events received but not parsed"
**Cause:** Event JSON format mismatch  
**Solution:** Check Event.fromJson() can parse Traccar event format  
**Test:** Enable debug logging in _handleWebSocketEvents()

### Issue 4: "Events parsed but not stored"
**Cause:** ObjectBox upsert failure  
**Solution:** Check EventsDao.upsertMany() logs

### Issue 5: "Events stored but not shown in UI"
**Cause:** Stream not emitting or UI not listening  
**Solution:** Check _emitEvents() and filteredNotificationsProvider

## Quick Test Script

Run this after deploying the fix:

```dart
// 1. Launch app with debug logging
flutter run

// 2. Monitor logs
grep "\[SOCKET\]" # Watch for WebSocket messages
grep "\[NotificationsRepository\]" # Watch for event processing

// 3. Trigger test event in Traccar UI
// - Turn off device to generate deviceOffline
// - Or create geofence and move device

// 4. Verify logs show:
// [SOCKET] 🔔 Received events from WebSocket
// [NotificationsRepository] 📨 Received WebSocket events
// [NotificationsRepository] ✅ Persisted X WebSocket events

// 5. Check UI
// - Toast notification appears
// - NotificationsPage shows new event
```

## Enhanced Logging

I've added comprehensive logging throughout the event flow. Look for these markers:

- `🔌` WebSocket subscription
- `📨` Message received
- `🔔` Events detected
- `✅` Success
- `❌` Error
- `⚠️` Warning
- `📦` Cache operation
- `📤` Stream emission

## Next Steps

1. ✅ **WebSocket subscription fixed** (just completed)
2. 🔄 **Deploy and test** (run `flutter run`)
3. ⏳ **Trigger test event** (use Test Event 2: Ignition On/Off)
4. ⏳ **Verify logs** (watch for event messages)
5. ⏳ **Confirm UI update** (notification appears)

## Support Resources

- Traccar Documentation: https://www.traccar.org/documentation/
- Traccar API Reference: https://www.traccar.org/api-reference/
- Traccar Forum: https://www.traccar.org/forums/
- WebSocket Protocol: https://www.traccar.org/socket/

## Contact Server Admin

If events are still not appearing after trying all steps, contact your Traccar server administrator to verify:
1. Event generation is enabled server-wide
2. Your user account has event permissions
3. Device is configured to trigger events
4. Server logs show events being generated
